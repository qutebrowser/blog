##################################
Days 37/38: Hints in master, tests
##################################

:category: webengine

*****
Hints
*****

Yesterday I merged the `pull request`_ I opened for the rewritten hint drawing
and `implemented`_ the missing bits so only visible hints are considered.

Together with some other small fixes and cleanups, I then merged the
`qtwebengine-hints`_ branch, which means hints are now working fine apart from
some corner cases with frames and iframes!

*****
Tests
*****

I `added`_ ``webelem.click()`` and ``webelem.hover()`` methods (to get some
more code out of ``hints.py`` and provide something useful for a future plugin
API) and added a new `click-element`_ command.

With that command, I was able to simplify a lot of tests (which used hinting to
click elements before), and then work on getting the end-to-end tests to run
with QtWebEngine.

This mostly meant implementing ``@qtwebengine_todo`` and ``@qtwebengine_skip``
tags and applying them all over the testsuite where things aren't ready yet.
However, there also were some other fixes:

- ``yankpaste.feature`` `checked`_ requests despite that not being necessary,
  which was flaky on QtWebEngine due to caching.
- Due to caching, the HTTP server used for tests would send a HTTP
  "not modified" answer which needed to be `whitelisted`_.
- Since hints are now async, the tests sometimes were faster than qutebrowser,
  so they needed some `changes`_ to wait until qutebrowser actually started
  hinting.
- Some tests waited for a specific tab to be `focused`_ which failed because
  with QtWebEngine, an internal ``QOpenGLWidget`` actually got the focus.
- "Running without the SUID sandbox" was `logged`_ by QtWebEngine (fixed in
  Qt 5.8) and failed the tests because it was an unknown message.
- Hint tests `did set`_ some options unavailable with QtWebEngine.
- Another test for ``:set`` `used`_ an option unavailable there.

The tests already found a handful of issues:

- ``:fake-key`` was not implemented yet, `now it is`_
- QtWebEngine saved titles which were autogenerated from the URL, which are
  `suppressed`_ now.
- Hinting raised a ``CommandError`` when no hints were found outside the
  command handler (since hinting is now async) and `crashed`_.
- Similarly, ``:view-source`` `raised`_ ``CommandError`` when used with an
  invalid URL.
- Some code sending custom key/mouse events `segfaulted`_.
- Some tests which scroll with a very big value caused a `memory leak`_ and
  thus were skipped for now until I know about a good workaround.

I also `decreased`_ the time the testsuite waits for a log line to appear until
it timeouts when a test is marked as TODO, which made the testsuite almost 5
minutes faster!

Some users also found another interesting bug: Mouse clicks are handled by an
`event filter`_ which then (among other things) checks if the clicked element
is editable. When closing a context menu, that event was however sent to the
``QMenu``, and the filter got coordinates relative to the menu.

Now when the user clicked in the area to the left or top to the panel, the
event filter got negative coordinates, which triggered an `assertion`_ when
trying to get the element at a negative position. The solution for that was to
`ignore`_ all events not going to the main widget.

**********
The future
**********

The next two weeks, I'll attend a preparation course for university. during
which I won't have much time available for qutebrowser, so I expect it to get a
bit more quiet again.

After that, I'll have another week or so until my study starts, during which I
hope to work on adblocking and some other essential smaller features.

Of course, during the study I'll continue working on QtWebEngine as my time
permits, but - unfortunately - not full-time anymore.

.. _pull request: https://github.com/The-Compiler/qutebrowser/pull/1868
.. _implemented: https://github.com/The-Compiler/qutebrowser/commit/9226e3eece7be77ff9d27fae5e97ba11994c59ac
.. _qtwebengine-hints: https://github.com/The-Compiler/qutebrowser/commit/2b6f4f06986b95b2f520d7ddd484925837d5b890
.. _added: https://github.com/The-Compiler/qutebrowser/commit/63c66945a439cc71db3b2166fd1174978f34dc79
.. _click-element: https://github.com/The-Compiler/qutebrowser/commit/0cef4ac2db5e572fd6a3b8654c5a2a2bfe4933f3
.. _checked: https://github.com/The-Compiler/qutebrowser/commit/a88adcca17615b3b043b238caeef42feb14f87be
.. _now it is: https://github.com/The-Compiler/qutebrowser/commit/c0ffcfc585f764904929e8518860bbcc336e8751
.. _suppressed: https://github.com/The-Compiler/qutebrowser/commit/dfed2f9c9c90c28ea768e72194b4d91b0fe0a771
.. _crashed: https://github.com/The-Compiler/qutebrowser/commit/2a0e503644e73336f9e3f37ee4c9d462b150fbb0
.. _whitelisted: https://github.com/The-Compiler/qutebrowser/commit/0b9aec873f1c1196ea87723a0c0511fac7bef74c
.. _changes: https://github.com/The-Compiler/qutebrowser/commit/745614e45d1cbb1754af9a8fc37c2d37aeca9d3d
.. _focused: https://github.com/The-Compiler/qutebrowser/commit/63628d2f97150219df9b6121dcdd30801a4b6ad1
.. _raised: https://github.com/The-Compiler/qutebrowser/commit/ccc676c04fbbf78c0911fa6fd4ed4313b0d3c835
.. _logged: https://github.com/The-Compiler/qutebrowser/commit/788eebc1ad1d67c2e62ac32bb5bc733d1d5b4563
.. _segfaulted: https://github.com/The-Compiler/qutebrowser/commit/0557fea79e50086fdcef6b51fa1da4eeda28000b
.. _memory leak: https://github.com/The-Compiler/qutebrowser/commit/8da942ddc759d9dcacd4a3a5f03492d72103e0cb
.. _did set: https://github.com/The-Compiler/qutebrowser/commit/63cc73d56dd7a3ad6d83866ba47f6f1e8bdeebd0
.. _used: https://github.com/The-Compiler/qutebrowser/commit/c0c327942472a2b6f54fbd3d2e3c884f0b682960
.. _decreased: https://github.com/The-Compiler/qutebrowser/commit/2eae6a06030f72a224bad1fe258f9f0f28edae3e
.. _event filter: https://github.com/The-Compiler/qutebrowser/blob/master/qutebrowser/browser/mouse.py
.. _assertion: https://github.com/The-Compiler/qutebrowser/blob/5ac9fe9c322868bf8a95400008dbb5f000cbbc22/qutebrowser/browser/webengine/webenginetab.py#L364-L366
.. _ignore: https://github.com/The-Compiler/qutebrowser/commit/fe11e25430f4def91fd702e478ff73cebe60dc7a
